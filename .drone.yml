---
kind: pipeline
type: docker
name: default

trigger:
  event:
    exclude:
      - pull_request

steps:
  - name: test
    image: golang:1.16
    commands:
      - DATABASE_USER=root DATABASE_PASSWORD=test DATABASE_HOST=mongo go test -coverprofile cover.out ./...
      - go tool cover -func cover.out

  - name: build
    image: golang:1.16
    commands:
      - make bundle

  - name: gitea_release
    image: plugins/gitea-release
    settings:
      base_url: https://git.luxs.at
      title: Spolyr Release
      api_key:
        from_secret: gitea_token
      files:
        - ./dist/*
    when:
      event: tag

  - name: latest docker image
    image: plugins/docker
    privileged: true
    settings:
      repo: imba28/spolyr
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      tags: latest
    when:
      branch: master
      event: push

  - name: docker tags
    image: plugins/docker
    privileged: true
    settings:
      repo: imba28/spolyr
      auto_tag: true
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      event: tag

services:
  - name: mongo
    image: mongo:4
    detach: true
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: test
